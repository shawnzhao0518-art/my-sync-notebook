<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æˆ‘çš„åŒæ­¥è®°äº‹æœ¬ï¼ˆè°ƒè¯•ç‰ˆï¼‰</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background:#fdfdfd; }
    h1 { font-size: 20px; }
    textarea { width: 100%; height: 60vh; font-size: 16px; padding: 10px; display:none; }
    #login { padding: 10px 20px; font-size: 16px; }
    .status { font-size: 12px; color: gray; }
    #log { margin-top: 20px; color: red; font-size: 14px; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>æˆ‘çš„åŒæ­¥è®°äº‹æœ¬ï¼ˆGoogle ç™»å½• + è°ƒè¯•ç‰ˆï¼‰</h1>
  <button id="login">ç”¨ Google ç™»å½•</button>
  <textarea id="note" placeholder="åœ¨è¿™é‡Œå†™ç¬”è®°..."></textarea>
  <div class="status" id="status">æœªä¿å­˜</div>
  <div id="log">æ—¥å¿—è¾“å‡ºåŒºï¼š</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <script>
    // ğŸ”‘ ä½ çš„ firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyDzc55STSEVIp6D4VzuXCTswWCxHc24EE4",
      authDomain: "my-sync-notebook.firebaseapp.com",
      projectId: "my-sync-notebook",
      storageBucket: "my-sync-notebook.appspot.com",
      messagingSenderId: "129475598049",
      appId: "1:129475598049:web:c678aa19cad00bf2ef240"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const textarea = document.getElementById("note");
    const status = document.getElementById("status");
    const loginBtn = document.getElementById("login");
    const logDiv = document.getElementById("log");

    function log(msg) {
      console.log(msg);
      logDiv.innerText += "\n" + msg;
    }

    let noteRef;

    // ç™»å½•æŒ‰é’®ï¼šä½¿ç”¨ Redirect ç™»å½•ï¼Œé¿å…è¢« iPad Safari æ‹¦æˆª
    loginBtn.onclick = () => {
      log("ç‚¹å‡»äº†ç™»å½•æŒ‰é’®ï¼Œå¼€å§‹è·³è½¬ Google ç™»å½•â€¦");
      auth.signInWithRedirect(provider);
    };

    // è·å–ç™»å½•ç»“æœ
    auth.getRedirectResult().then(result => {
      if (result.user) {
        log("ç™»å½•æˆåŠŸï¼š" + result.user.displayName);
      }
    }).catch(error => {
      log("ç™»å½•å¤±è´¥ï¼š" + error.message);
    });

    // ç™»å½•çŠ¶æ€ç›‘å¬
    auth.onAuthStateChanged(user => {
      if (user) {
        loginBtn.style.display = "none";
        textarea.style.display = "block";
        status.textContent = "æ¬¢è¿ " + user.displayName + "ï¼Œæ­£åœ¨åŒæ­¥â€¦";
        log("å·²ç™»å½•ç”¨æˆ·ï¼š" + user.email);

        // æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹æ–‡æ¡£
        noteRef = db.collection("users").doc(user.uid);

        // å®æ—¶åŒæ­¥
        noteRef.onSnapshot(doc => {
          if (doc.exists) {
            textarea.value = doc.data().content || "";
            log("æˆåŠŸåŠ è½½ç¬”è®°å†…å®¹ã€‚");
          } else {
            log("æ²¡æœ‰æ‰¾åˆ°ç¬”è®°æ–‡æ¡£ï¼Œå°†ä¼šæ–°å»ºã€‚");
            noteRef.set({ content: "" });
          }
        });

        // è¾“å…¥æ—¶ä¿å­˜
        let timeout;
        textarea.addEventListener("input", () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            noteRef.set({ content: textarea.value });
            status.textContent = "å·²ä¿å­˜";
            log("ç¬”è®°å·²ä¿å­˜ã€‚");
          }, 500);
          status.textContent = "ä¿å­˜ä¸­â€¦";
        });

      } else {
        loginBtn.style.display = "block";
        textarea.style.display = "none";
        status.textContent = "è¯·å…ˆç™»å½•";
        log("å½“å‰æ²¡æœ‰ç”¨æˆ·ç™»å½•ã€‚");
      }
    });
  </script>
</body>
</html>
