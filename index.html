<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>我的同步记事本（安全登录版）</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background:#fdfdfd; }
    h1 { font-size: 20px; }
    textarea { width: 100%; height: 70vh; font-size: 16px; padding: 10px; display:none; }
    #login { padding: 10px 20px; font-size: 16px; }
    .status { font-size: 12px; color: gray; }
  </style>
</head>
<body>
  <h1>我的同步记事本（需要 Google 登录）</h1>
  <button id="login">用 Google 登录</button>
  <textarea id="note" placeholder="在这里写笔记..."></textarea>
  <div class="status" id="status">未保存</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <script>
    // 你的 firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyDzc55STSEVIp6D4VzuXCTswWCxHc24EE4",
      authDomain: "my-sync-notebook.firebaseapp.com",
      projectId: "my-sync-notebook",
      storageBucket: "my-sync-notebook.appspot.com",
      messagingSenderId: "129475598049",
      appId: "1:129475598049:web:c678aa19cad00bf2ef240"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const textarea = document.getElementById("note");
    const status = document.getElementById("status");
    const loginBtn = document.getElementById("login");

    let noteRef;

    // 登录按钮：用 redirect 而不是 popup
    loginBtn.onclick = () => {
      auth.signInWithRedirect(provider);
    };

    // 获取重定向的登录结果
    auth.getRedirectResult().then(result => {
      if (result.user) {
        console.log("登录成功：", result.user.displayName);
      }
    }).catch(error => {
      console.error("登录失败：", error);
    });

    // 登录状态监听
    auth.onAuthStateChanged(user => {
      if (user) {
        loginBtn.style.display = "none";
        textarea.style.display = "block";
        status.textContent = "欢迎 " + user.displayName + "，正在同步...";

        // 每个用户独立文档
        noteRef = db.collection("users").doc(user.uid);

        // 实时同步
        noteRef.onSnapshot(doc => {
          if (doc.exists) {
            textarea.value = doc.data().content || "";
          }
        });

        // 输入时保存
        let timeout;
        textarea.addEventListener("input", () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            noteRef.set({ content: textarea.value });
            status.textContent = "已保存";
          }, 500);
          status.textContent = "保存中...";
        });

      } else {
        loginBtn.style.display = "block";
        textarea.style.display = "none";
        status.textContent = "请先登录";
      }
    });
  </script>
</body>
</html>
